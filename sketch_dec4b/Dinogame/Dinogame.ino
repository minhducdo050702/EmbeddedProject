

// Include
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include "pitches.h"
#include <EEPROM.h>
#define BUTTON_PIN 19
#define LED_PIN 2
#define BUZZER_PIN 18
// Defines
#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels

#define OLED_RESET 4 // Reset pin # (or -1 if sharing Arduino reset pin)
#define SCREEN_ADDRESS 0x3C

#define DINO_WIDTH 25
#define DINO_HEIGHT 26
#define DINO_INIT_X 10 // Dino initial spawn location
#define DINO_INIT_Y 29 // Dino initial spawn location

#define BASE_LINE_X 0
#define BASE_LINE_Y 54
#define BASE_LINE_X1 127
#define BASE_LINE_Y1 54

#define TREE1_WIDTH 11
#define TREE1_HEIGHT 23

#define TREE2_WIDTH 22
#define TREE2_HEIGHT 23

#define TREE_Y 35

#define JUMP_PIXEL 22 // Number of pixel dino will jump
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
int highest_score = 0;
int cur_score = 0;
int highest_score_add = 0;
static const unsigned char PROGMEM dino1[] = {
	// 'dino', 25x26px
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x06, 0xff, 0x00, 0x00, 0x0e, 0xff, 0x00,
	0x00, 0x0f, 0xff, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x00, 0x0f, 0xc0, 0x00,
	0x00, 0x0f, 0xfc, 0x00, 0x40, 0x0f, 0xc0, 0x00, 0x40, 0x1f, 0x80, 0x00, 0x40, 0x7f, 0x80, 0x00,
	0x60, 0xff, 0xe0, 0x00, 0x71, 0xff, 0xa0, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x7f, 0xff, 0x80, 0x00,
	0x7f, 0xff, 0x80, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x1f, 0xff, 0x00, 0x00, 0x0f, 0xfe, 0x00, 0x00,
	0x03, 0xfc, 0x00, 0x00, 0x01, 0xdc, 0x00, 0x00, 0x01, 0x8c, 0x00, 0x00, 0x01, 0x8c, 0x00, 0x00,
	0x01, 0x0c, 0x00, 0x00, 0x01, 0x8e, 0x00, 0x00};

static const unsigned char PROGMEM tree1[] = {
	// 'tree1', 11x23px
	0x1e, 0x00, 0x1f, 0x00, 0x1f, 0x40, 0x1f, 0xe0, 0x1f, 0xe0, 0xdf, 0xe0, 0xff, 0xe0, 0xff, 0xe0,
	0xff, 0xe0, 0xff, 0xe0, 0xff, 0xe0, 0xff, 0xe0, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0x7f, 0x00,
	0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00};

static const unsigned char PROGMEM tree2[] = {
	// 'tree2', 22x23px
	0x1e, 0x01, 0xe0, 0x1f, 0x03, 0xe0, 0x1f, 0x4f, 0xe8, 0x1f, 0xff, 0xfc, 0x1f, 0xff, 0xfc, 0xdf,
	0xff, 0xfc, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xfc, 0xff, 0xff,
	0xfc, 0xff, 0xef, 0xfc, 0xff, 0x83, 0xfc, 0xff, 0x03, 0xfc, 0xff, 0x03, 0xf8, 0x7f, 0x03, 0xe0,
	0x1f, 0x03, 0xe0, 0x1f, 0x03, 0xe0, 0x1f, 0x03, 0xe0, 0x1f, 0x03, 0xe0, 0x1f, 0x03, 0xe0, 0x1f,
	0x03, 0xe0, 0x1f, 0x03, 0xe0};
static const unsigned char PROGMEM trex[] = {
	// 64 64
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0x9f, 0xcf,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc9, 0xff, 0xd7, 0xff, 0xff, 0xff, 0xff, 0xff, 0x10, 0x3f, 0xef,
	0xff, 0xff, 0xff, 0xff, 0xfe, 0x60, 0x3f, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x7c, 0x73,
	0xff, 0xff, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xff, 0x1c, 0x0f,
	0xff, 0xff, 0xff, 0xff, 0xf7, 0xfe, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xe7, 0x7c, 0x00, 0x7f,
	0xff, 0xff, 0xff, 0xff, 0x86, 0xec, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x06, 0xfc, 0x1f, 0xff,
	0xff, 0xff, 0xfe, 0x07, 0xc6, 0xf4, 0x1f, 0xff, 0xff, 0xff, 0xfc, 0x3f, 0xfc, 0xf8, 0x1f, 0xff,
	0xff, 0xff, 0xf8, 0xff, 0xfc, 0x7c, 0x5f, 0xff, 0xff, 0xff, 0xf1, 0xff, 0xf8, 0x3e, 0x6f, 0xff,
	0xff, 0xff, 0xf3, 0xff, 0xf8, 0x1f, 0x57, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xf8, 0x07, 0xa3, 0xff,
	0xff, 0xff, 0xcf, 0xff, 0xf0, 0x01, 0xf8, 0x3f, 0xff, 0xff, 0x0f, 0xff, 0xe0, 0x00, 0x3f, 0x9f,
	0xff, 0xc0, 0xdb, 0xff, 0xc0, 0x0f, 0x8f, 0xdf, 0xfe, 0x3f, 0x3b, 0xfd, 0x80, 0x1f, 0xe0, 0x3f,
	0xfc, 0xfe, 0x39, 0xfd, 0x80, 0x3f, 0xf8, 0x7f, 0xfb, 0xf0, 0x78, 0xfb, 0x80, 0x7f, 0xff, 0xff,
	0xf7, 0x80, 0x78, 0x76, 0x00, 0x3f, 0xff, 0xff, 0xee, 0x00, 0xf8, 0x04, 0x00, 0xbf, 0xff, 0xff,
	0xe8, 0x00, 0xf8, 0x0e, 0x01, 0xdf, 0xff, 0xff, 0xd0, 0x00, 0xf8, 0x0f, 0x01, 0xff, 0xff, 0xff,
	0xd1, 0xfc, 0xf8, 0x07, 0x04, 0xef, 0xff, 0xff, 0xd3, 0xfc, 0xf8, 0x03, 0x06, 0x7d, 0xff, 0xff,
	0xd7, 0xfc, 0x70, 0x01, 0xf3, 0xbe, 0xff, 0xff, 0xd7, 0xfc, 0x70, 0x01, 0xe3, 0x88, 0xff, 0xff,
	0xf7, 0xfc, 0xe0, 0x00, 0xeb, 0x91, 0xff, 0xff, 0xeb, 0xfe, 0xf0, 0x00, 0xb3, 0xb7, 0xff, 0xff,
	0xf1, 0xfe, 0xf0, 0x00, 0x87, 0xff, 0xff, 0xff, 0xfc, 0xfd, 0x82, 0x08, 0x0f, 0xff, 0xff, 0xff,
	0xff, 0xf9, 0x83, 0xf8, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xc3, 0xf1, 0xbf, 0xff, 0xff, 0xff,
	0xff, 0xfb, 0xc3, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xc7, 0xe1, 0x9f, 0xff, 0xff, 0xff,
	0xff, 0xf9, 0x87, 0xe0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfd, 0x8f, 0xf0, 0x7f, 0xff, 0xff, 0xff,
	0xff, 0xfd, 0x9f, 0xfc, 0x39, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xff, 0xfc, 0x1e, 0xff, 0xff, 0xff,
	0xff, 0xfc, 0x5f, 0xfe, 0x1f, 0x7f, 0xff, 0xff, 0xff, 0xfc, 0x3f, 0xff, 0x0f, 0xff, 0xff, 0xff,
	0xff, 0xfd, 0xef, 0xff, 0x83, 0xec, 0x3f, 0xff, 0xff, 0xff, 0xf7, 0xff, 0xc1, 0xb8, 0x1f, 0xff,
	0xff, 0xff, 0xf9, 0xff, 0xc0, 0x80, 0x4f, 0xff, 0xff, 0xff, 0xf1, 0xff, 0xc4, 0x01, 0xff, 0xff,
	0xff, 0xde, 0x1e, 0xff, 0xe6, 0x1c, 0xff, 0xff, 0xff, 0x80, 0x00, 0xff, 0xff, 0x1f, 0xff, 0xff,
	0xff, 0x00, 0x00, 0x7f, 0xff, 0x9f, 0xff, 0xff, 0xff, 0x86, 0x3c, 0x7f, 0xff, 0xff, 0xff, 0xff,
	0xff, 0x9e, 0x7e, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};
static const unsigned char PROGMEM trexcry[] = {
	// 64 64
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xe0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0x03, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xf1, 0xff, 0xf1, 0xfc, 0x3f, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xfe, 0x60, 0x1f, 0xff,
	0xff, 0xff, 0x3f, 0xff, 0xff, 0x80, 0x1f, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xc0, 0x1f, 0xff,
	0xff, 0xfc, 0xff, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xf8, 0x1f, 0xff,
	0xff, 0xfb, 0xff, 0xff, 0xff, 0xfc, 0x1f, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xff,
	0xff, 0xef, 0xff, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff,
	0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xbf, 0xff,
	0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff,
	0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff,
	0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0x7f, 0x87, 0xff, 0xfc, 0x3f, 0xe0, 0xff,
	0xff, 0x7f, 0x03, 0xff, 0xf8, 0x1f, 0xe1, 0xff, 0xff, 0x7f, 0x03, 0xff, 0xf8, 0x1f, 0xe3, 0xff,
	0xff, 0x7f, 0x03, 0xff, 0xf8, 0x1f, 0xe7, 0xff, 0xff, 0x7f, 0x83, 0xff, 0xfe, 0x3f, 0xcf, 0xff,
	0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff,
	0xff, 0xbf, 0xff, 0xe0, 0x7f, 0xff, 0xdf, 0xff, 0xff, 0xbf, 0xff, 0xdf, 0xbf, 0xff, 0x9f, 0xff,
	0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff,
	0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff,
	0xff, 0xf3, 0xff, 0xff, 0xff, 0xfc, 0x07, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff,
	0xff, 0xfe, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0x9f, 0xff, 0xff,
	0xff, 0xff, 0xc7, 0xff, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0x80, 0x7f, 0xff, 0xff,
	0xff, 0xff, 0xfb, 0x00, 0x1c, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xff,
	0xff, 0xff, 0xf7, 0xff, 0x7e, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xdf, 0xfe, 0x1f, 0xff, 0xff,
	0xff, 0xff, 0xe6, 0xdf, 0x6e, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0x1f, 0xff, 0xff,
	0xff, 0xff, 0xef, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xef, 0x3f, 0x9f, 0x03, 0xff, 0xff,
	0xff, 0xff, 0xe2, 0xdf, 0xe9, 0x01, 0xff, 0xff, 0xff, 0xff, 0xef, 0xdf, 0xfe, 0x79, 0xff, 0xff,
	0xff, 0xff, 0xef, 0xdf, 0x7e, 0x7d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0x7e, 0x79, 0xff, 0xff,
	0xff, 0xff, 0xf7, 0xdf, 0xfc, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xbf, 0xb8, 0x0f, 0xff, 0xff,
	0xff, 0xff, 0xfe, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};
void setup()
{
	Serial.begin(9600);
	EEPROM.begin(512);
	highest_score = EEPROM.read(0);
	//   EEPROM.writeInt(highest_score_add, highest_score);
	//   EEPROM.commit();
	pinMode(BUTTON_PIN, INPUT_PULLUP);
	pinMode(LED_PIN, OUTPUT);
	pinMode(BUZZER_PIN, OUTPUT);
	if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS))
	{
		Serial.println(F("SSD1306 allocation failed"));
		for (;;)
			;
	}

	// Clear the buffer
	display.clearDisplay();

	introMessage();
}

void loop()
{
	if (checkButton() == 1)
	{
		play();
	}
}
void music_die()
{
	int melody[] = {NOTE_C4, NOTE_G3, NOTE_G3, NOTE_A3, NOTE_G3, 0, NOTE_B3, NOTE_C4};

	int noteDurations[] = {
		4, 8, 8, 4, 4, 4, 4, 4};
	for (int thisNote = 0; thisNote < 8; thisNote++)
	{
		int noteDuration = 1000 / noteDurations[thisNote];
		tone(BUZZER_PIN, melody[thisNote], noteDuration);

		int pauseBetweenNotes = noteDuration * 1.30;
		delay(pauseBetweenNotes);
		noTone(BUZZER_PIN);
	}
}
void introMessage()
{
	display.setTextSize(2); // Draw 2X-scale text
	display.setTextColor(SSD1306_WHITE);
	display.setCursor(70, 5);
	display.println("Dino");
	display.setCursor(80, 20);
	display.println("Game");
	display.setTextSize(1);

	display.setCursor(70, 35);
	display.println("Press");
	display.setCursor(70, 45);
	display.println("Button");
	display.setCursor(70, 55);
	display.println("To Play");
	display.drawBitmap(0, 0, trex, 64, 64, SSD1306_WHITE);

	display.display();
}
int checkButton()
{
	int buttonState = digitalRead(BUTTON_PIN);
	if (buttonState == LOW)
	{
		// Bật đèn LED
		digitalWrite(LED_PIN, HIGH);

		// Bật buzzer
		digitalWrite(BUZZER_PIN, HIGH);
		return 1;
	}
	else
	{
		// Tắt đèn LED
		digitalWrite(LED_PIN, LOW);

		// Tắt buzzer
		digitalWrite(BUZZER_PIN, LOW);
		return 0;
	}
}
// Move dino function
void moveDino(int16_t *y, int type = 0)
{
	display.drawBitmap(DINO_INIT_X, *y, dino1, DINO_WIDTH, DINO_HEIGHT, SSD1306_WHITE);
}

// Move tree funciton
void moveTree(int16_t *x, int type = 0)
{
	if (type == 0)
	{
		display.drawBitmap(*x, TREE_Y, tree1, TREE1_WIDTH, TREE1_HEIGHT, SSD1306_WHITE);
	}
	else if (type == 1)
	{
		display.drawBitmap(*x, TREE_Y, tree2, TREE2_WIDTH, TREE2_HEIGHT, SSD1306_WHITE);
	}
}
// Game over display with score
void gameOver(int score = 0)
{
	delay(400);
	display.clearDisplay();
	display.drawBitmap(32, 0, trexcry, 64, 64, SSD1306_WHITE);
	display.display();
	music_die();
	delay(400);
	display.clearDisplay();

	display.setTextSize(1); // Draw 2X-scale text
	display.setTextColor(SSD1306_WHITE);
	display.setCursor(40, 5);
	display.println("Game Over");

	display.setTextSize(1);

	display.setCursor(1, 15);
	display.print("Score: ");
	display.print(score);
	display.setCursor(1, 30);
	display.print("Highest Score: ");
	display.print(highest_score);
	display.setCursor(1, 45);
	display.println("Press Button To Play Again");
	display.display();
}

// Display score while running the game
void displayScore(int score)
{
	display.setTextSize(1);
	display.setCursor(64, 10);
	display.print("Score: ");
	display.print(score);
}

// Main play function
void play()
{

	int16_t tree_x = 127;
	int16_t tree1_x = 195;
	int tree_type = random(0, 2);
	int tree_type1 = random(0, 2);

	int16_t dino_y = DINO_INIT_Y;
	int jump = 0;
	int score = 0;

	for (;;)
	{
		display.clearDisplay();
		if (checkButton() == 1)
		{
			if (jump == 0)
				jump = 1;
		}

		if (jump == 1)
		{
			dino_y--;
			if (dino_y == (DINO_INIT_Y - JUMP_PIXEL))
			{
				jump = 2;
				score++;
			}
		}
		else if (jump == 2)
		{
			dino_y++;
			if (dino_y == DINO_INIT_Y)
			{
				jump = 0;
			}
		}

		if (tree_x <= (DINO_INIT_X + DINO_WIDTH) && tree_x >= (DINO_INIT_X + (DINO_WIDTH / 2)))
		{
			if (dino_y >= (DINO_INIT_Y - 3))
			{
				break;
			}
		}

		if (tree1_x <= (DINO_INIT_X + DINO_WIDTH) && tree1_x >= (DINO_INIT_X + (DINO_WIDTH / 2)))
		{
			if (dino_y >= (DINO_INIT_Y - 3))
			{
				break;
			}
		}
		displayScore(score);
		moveTree(&tree_x, tree_type);
		moveTree(&tree1_x, tree_type1);
		moveDino(&dino_y);
		display.drawLine(0, 54, 127, 54, SSD1306_WHITE);

		tree_x--;
		tree1_x--;
		if (tree_x == 0)
		{
			tree_x = 127;
			tree_type = random(0, 1);
		}

		if (tree1_x == 0)
		{
			tree1_x = 195;
			tree_type1 = random(0, 1);
		}
		display.display();
	}

	if (score > highest_score)
	{
		highest_score = score;
		EEPROM.write(0, score);
		EEPROM.commit();
	}
	gameOver(score);
}

void renderScene(int16_t i = 0)
{
	display.drawBitmap(10, 29, dino1, 25, 26, SSD1306_WHITE);
	display.drawBitmap(50, TREE_Y, tree1, 11, 23, SSD1306_WHITE);
	display.drawBitmap(100, TREE_Y, tree2, 22, 23, SSD1306_WHITE);
	display.drawLine(0, 54, 127, 54, SSD1306_WHITE);
	display.drawPixel(i, 60, SSD1306_WHITE);
}